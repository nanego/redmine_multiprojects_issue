# Security Vulnerability Assessment: Redmine Multiprojects_issues Plugin

## Executive Summary

The Redmine Multiprojects_issues plugin (version 5.0.2) contains several security vulnerabilities ranging from **CRITICAL** to **LOW** severity. The most concerning issues involve SQL injection vulnerabilities, authorization bypass, and cross-site scripting (XSS) risks.

## Identified Vulnerabilities

### 1. **CRITICAL** - SQL Injection in Project Statement Construction
**File**: `lib/redmine_multiprojects_issue/issue_query_patch.rb`  
**Lines**: 7-10

```ruby
if project_clauses && project && with_multiprojects && allowed
  "((#{project_clauses}) OR #{Issue.table_name}.id IN (SELECT issue_id FROM issues_projects WHERE project_id = #{project.id}))"
```

**Issue**: Direct interpolation of `project.id` into SQL query without proper parameterization.
**Impact**: Could allow SQL injection if an attacker can control the project ID through crafted requests.
**Recommendation**: Use parameterized queries or proper escaping.

### 2. **HIGH** - Mass Assignment Vulnerability
**File**: `lib/redmine_multiprojects_issue/issues_controller_patch.rb`  
**Lines**: 39-45

```ruby
if params[:issue] && params[:issue][:project_ids]
  params[:issue][:project_ids].reject!(&:blank?)
  if params[:issue][:project_ids].present?
    Project.where(id: params[:issue][:project_ids]).each do |p|
```

**Issue**: Direct usage of user-controlled parameters without sufficient validation.
**Impact**: Attackers could potentially manipulate project assignments beyond intended permissions.
**Recommendation**: Implement strict parameter validation and whitelist allowed project IDs.

### 3. **HIGH** - Authorization Bypass in Update Method
**File**: `lib/redmine_multiprojects_issue/issues_controller_patch.rb`  
**Lines**: 75-80

```ruby
def authorize(ctrl = params[:controller], action = params[:action], global = false)
  if ctrl == "issues" && action == "update"
    @issue.editable?
  else
    super
  end
end
```

**Issue**: Custom authorization logic bypasses standard Redmine permissions for issue updates.
**Impact**: Could allow unauthorized users to update issues if they have access to secondary projects.
**Recommendation**: Ensure consistent authorization checks across all code paths.

### 4. **HIGH** - CSRF Protection Bypass
**File**: `lib/redmine_multiprojects_issue/issues_controller_patch.rb`  
**Line**: 100

```ruby
skip_forgery_protection only: :load_projects_selection
```

**Issue**: CSRF protection is explicitly disabled for the `load_projects_selection` action.
**Impact**: Attackers could perform cross-site request forgery attacks against this endpoint.
**Recommendation**: Implement proper CSRF protection or justify why it's not needed.

### 5. **MEDIUM** - XSS Vulnerability via `html_safe`
**File**: `lib/redmine_multiprojects_issue/application_helper_patch.rb`  
**Line**: 47

```ruby
s.html_safe
```

**File**: `lib/redmine_multiprojects_issue/issues_helper_patch.rb`  
**Lines**: 29, 45

```ruby
"#{value.size} #{value.size>1 ? l(:text_journal_projects_added) : l(:text_journal_project_added)} #{details}".html_safe
```

**Issue**: Using `html_safe` on user-controllable content without proper sanitization.
**Impact**: Potential XSS attacks if project names or other user input contain malicious scripts.
**Recommendation**: Sanitize all user input before marking as `html_safe`.

### 6. **MEDIUM** - Information Disclosure via Visibility Bypass
**File**: `lib/redmine_multiprojects_issue/issue_custom_field_patch.rb`  
**Lines**: 15-17

```ruby
##### START PATCH ##### remove "AND (#{Issue.visible_condition(user)})" because it slows down the query too much
"((#{sql}) AND (#{tracker_condition}) AND (#{project_condition}))"
```

**Issue**: Removing visibility conditions to improve performance could expose sensitive information.
**Impact**: Users might see custom field values they shouldn't have access to.
**Recommendation**: Find alternative performance optimizations that maintain security.

### 7. **MEDIUM** - Unsafe JavaScript Template Rendering
**File**: `app/views/issues/_select_projects.html.erb`  
**Line**: 24

```ruby
url: "<%= raw(plugin_multiprojects_issue_load_projects_selection_path(...)) %>"
```

**Issue**: Using `raw()` helper in JavaScript context without proper escaping.
**Impact**: Potential XSS if URL parameters contain malicious content.
**Recommendation**: Use proper JavaScript escaping methods.

### 8. **LOW** - Unvalidated Direct Object Reference
**File**: `lib/redmine_multiprojects_issue/issues_controller_patch.rb`  
**Lines**: 4-5

```ruby
if params[:issue_id]
  @issue = Issue.where(id: params[:issue_id]).first
```

**Issue**: Direct usage of user-provided ID without authorization check at this point.
**Impact**: Information disclosure if authorization is not properly checked later.
**Recommendation**: Add immediate authorization checks after object loading.

### 9. **LOW** - Missing Input Validation
**File**: `lib/redmine_multiprojects_issue/issues_controller_patch.rb`  
**Lines**: 14-16

```ruby
if params[:project_ids]
  project_ids = params[:project_ids].split(',')
```

**Issue**: No validation of the format or content of `project_ids` parameter.
**Impact**: Could cause application errors or unexpected behavior.
**Recommendation**: Add proper input validation and sanitization.

## Recommendations

### Immediate Actions (Critical/High Priority)
1. **Fix SQL Injection**: Replace string interpolation with parameterized queries
2. **Review Authorization Logic**: Ensure consistent permission checks across all actions
3. **Implement CSRF Protection**: Remove the `skip_forgery_protection` or justify its necessity
4. **Sanitize HTML Output**: Review all `html_safe` usage and ensure proper escaping

### Medium Priority
1. **Performance vs Security**: Find alternatives to removing visibility conditions
2. **JavaScript Security**: Properly escape all data in JavaScript contexts
3. **Input Validation**: Implement comprehensive parameter validation

### Security Best Practices
1. **Regular Security Audits**: Implement automated security scanning
2. **Dependency Updates**: Keep Redmine and plugin dependencies updated
3. **Least Privilege**: Ensure users have minimum necessary permissions
4. **Security Testing**: Add security-focused test cases

## Plugin Dependencies Security

The plugin depends on:
- `redmine_base_deface` (version >= 0.0.1)
- `redmine_base_stimulusjs` (version >= 1.0.1)

**Recommendation**: Audit these dependencies for security vulnerabilities as they could introduce additional attack vectors.

## Overall Risk Rating: **HIGH**

The combination of SQL injection, authorization bypass, and CSRF protection bypass creates significant security risks that should be addressed immediately before using this plugin in a production environment.